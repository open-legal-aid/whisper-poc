<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è Whisper Transcriber ‚Äì LegalAId</title>
    <style>
        /* ===== CSS VARIABLES (THEME SUPPORT) ===== */
        :root {
            --primary: #00A8B5;
            --success: #22C55E;
            --warning: #F97316;
            --error: #EF4444;
            --bg-light: #F9FAFB;
            --bg-dark: #1F2937;
            --text-light: #111827;
            --text-dark: #F9FAFB;
            --border-light: #E5E7EB;
            --border-dark: #374151;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg: var(--bg-dark);
            --text: var(--text-dark);
            --border: var(--border-dark);
            --output-bg: #111827;
            --output-text: #E5E7EB;
        }

        [data-theme="light"] {
            --bg: var(--bg-light);
            --text: var(--text-light);
            --border: var(--border-light);
            --output-bg: #FFFFFF;
            --output-text: #111827;
        }

        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Roboto', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px var(--shadow);
            padding: 24px;
        }

        /* ===== HEADER ===== */
        header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--border);
        }

        header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary);
        }

        header p {
            font-size: 16px;
            font-weight: 500;
            color: var(--text);
            opacity: 0.8;
            margin-bottom: 16px;
        }

        /* ===== LANGUAGE SELECTOR ===== */
        .language-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .lang-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .lang-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .lang-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== CONTROL PANEL ===== */
        .control-panel {
            margin-bottom: 32px;
        }

        .status-badge {
            text-align: center;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            background: var(--border);
            position: relative;
        }

        .status-badge.ready {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .status-badge.recording {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .status-badge.processing {
            background: rgba(0, 168, 181, 0.1);
            color: var(--primary);
        }

        .status-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .recording-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: var(--error);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: var(--error);
            color: white;
        }

        .btn-stop {
            background: var(--warning);
            color: white;
        }

        .btn-transcribe {
            background: var(--success);
            color: white;
        }

        .btn-copy {
            background: var(--primary);
            color: white;
        }

        .btn-clear {
            background: var(--border);
            color: var(--text);
        }

        .timer {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            margin-top: 16px;
        }

        /* ===== OUTPUT SECTION ===== */
        .output-section {
            margin-bottom: 24px;
        }

        .output-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        #output {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--output-bg);
            color: var(--output-text);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            overflow-y: auto;
        }

        #output:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .output-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            justify-content: center;
        }

        .output-actions .btn {
            min-width: 120px;
        }

        /* ===== METADATA ===== */
        .metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 16px;
            background: var(--border);
            border-radius: 8px;
        }

        .meta-item {
            font-size: 14px;
            color: var(--text);
        }

        .meta-item span {
            font-weight: 600;
            color: var(--primary);
        }

        /* ===== FEEDBACK MESSAGES ===== */
        .feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .feedback.success {
            background: var(--success);
            color: white;
        }

        .feedback.error {
            background: var(--error);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== SPINNER ===== */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            header h1 {
                font-size: 24px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            #output {
                min-height: 300px;
            }

            .metadata {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <!-- HEADER -->
        <header>
            <h1>üéôÔ∏è Whisper Transcriber</h1>
            <p>Unter-Projekt von LegalAId ‚Äì Spracherkennung im Browser</p>
            <div class="language-selector" role="group" aria-label="Sprache ausw√§hlen">
                <button class="lang-btn active" data-lang="de" aria-label="Deutsch">üá©üá™ Deutsch</button>
                <button class="lang-btn" data-lang="en" aria-label="English">üá¨üáß English</button>
                <button class="lang-btn" data-lang="fr" aria-label="Fran√ßais">üá´üá∑ Fran√ßais</button>
            </div>
        </header>

        <!-- CONTROL PANEL -->
        <section class="control-panel">
            <div class="status-badge ready" id="status">
                Status: Bereit
            </div>
            <div class="button-group">
                <button class="btn btn-start" id="btnStart" aria-label="Aufnahme starten">
                    üî¥ Start
                </button>
                <button class="btn btn-stop" id="btnStop" disabled aria-label="Aufnahme stoppen">
                    ‚õî Stop
                </button>
                <button class="btn btn-transcribe" id="btnTranscribe" disabled aria-label="Transkribieren">
                    ‚ú® Transcribe
                </button>
            </div>
            <div class="timer" id="timer" aria-live="polite">00:00</div>
        </section>

        <!-- OUTPUT SECTION -->
        <section class="output-section">
            <h3>Transkription:</h3>
            <textarea id="output" readonly aria-label="Transkriptions-Ergebnis" placeholder="Hier erscheint die Transkription..."></textarea>
            <div class="output-actions">
                <button class="btn btn-copy" id="btnCopy" aria-label="Text kopieren">
                    üìã Kopieren
                </button>
                <button class="btn btn-clear" id="btnClear" aria-label="Text l√∂schen">
                    üóëÔ∏è L√∂schen
                </button>
            </div>
        </section>

        <!-- METADATA -->
        <section class="metadata">
            <div class="meta-item">
                Erkannte Sprache: <span id="detected-lang">‚Äî</span>
            </div>
            <div class="meta-item">
                Audio-Dauer: <span id="duration">‚Äî</span>
            </div>
            <div class="meta-item">
                Confidence: <span id="confidence">‚Äî</span>
            </div>
            <div class="meta-item">
                Verarbeitungszeit: <span id="processing-time">‚Äî</span>
            </div>
        </section>
    </div>

    <script>
        // ===== STATE MANAGEMENT =====
        const state = {
            isRecording: false,
            audioBlob: null,
            audioChunks: [],
            mediaRecorder: null,
            stream: null,
            timer: 0,
            timerInterval: null,
            currentLanguage: localStorage.getItem('whisper-lang') || 'de',
            detectedLanguage: null,
            confidence: null,
            processingTime: null,
            audioDuration: null
        };

        // ===== DOM ELEMENTS =====
        const elements = {
            btnStart: document.getElementById('btnStart'),
            btnStop: document.getElementById('btnStop'),
            btnTranscribe: document.getElementById('btnTranscribe'),
            btnCopy: document.getElementById('btnCopy'),
            btnClear: document.getElementById('btnClear'),
            output: document.getElementById('output'),
            status: document.getElementById('status'),
            timer: document.getElementById('timer'),
            langButtons: document.querySelectorAll('.lang-btn'),
            detectedLang: document.getElementById('detected-lang'),
            duration: document.getElementById('duration'),
            confidence: document.getElementById('confidence'),
            processingTime: document.getElementById('processing-time')
        };

        // ===== THEME DETECTION =====
        function initTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.body.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            });
        }

        // ===== LANGUAGE SELECTION =====
        function initLanguage() {
            elements.langButtons.forEach(btn => {
                if (btn.dataset.lang === state.currentLanguage) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => {
                    elements.langButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentLanguage = btn.dataset.lang;
                    localStorage.setItem('whisper-lang', state.currentLanguage);
                    showFeedback(`Sprache ge√§ndert zu: ${btn.textContent}`, 'success');
                });
            });
        }

        // ===== AUDIO RECORDING =====
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.stream = stream;
                state.audioChunks = [];
                
                state.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        state.audioChunks.push(event.data);
                    }
                };

                state.mediaRecorder.onstop = () => {
                    state.audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                    state.audioDuration = state.timer;
                    updateDuration();
                    elements.btnTranscribe.disabled = false;
                    showFeedback('Aufnahme beendet', 'success');
                };

                state.mediaRecorder.start();
                state.isRecording = true;
                updateStatus('recording', 'Status: Aufnahme l√§uft...');
                startTimer();
                updateButtons();
                
            } catch (error) {
                console.error('Fehler beim Starten der Aufnahme:', error);
                showFeedback('Mikrofon-Zugriff verweigert. Bitte Berechtigung erteilen.', 'error');
            }
        }

        function stopRecording() {
            if (state.mediaRecorder && state.isRecording) {
                state.mediaRecorder.stop();
                state.stream.getTracks().forEach(track => track.stop());
                state.isRecording = false;
                stopTimer();
                updateStatus('ready', 'Status: Bereit');
                updateButtons();
            }
        }

        // ===== TIMER =====
        function startTimer() {
            state.timer = 0;
            state.timerInterval = setInterval(() => {
                state.timer++;
                updateTimer();
            }, 1000);
        }

        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }

        function updateTimer() {
            const minutes = Math.floor(state.timer / 60).toString().padStart(2, '0');
            const seconds = (state.timer % 60).toString().padStart(2, '0');
            elements.timer.textContent = `${minutes}:${seconds}`;
        }

        // ===== TRANSCRIPTION =====
        async function transcribe() {
            if (!state.audioBlob) {
                showFeedback('Keine Audio-Datei vorhanden', 'error');
                return;
            }

            updateStatus('processing', 'Status: Verarbeitung...');
            elements.btnTranscribe.disabled = true;
            elements.btnTranscribe.innerHTML = '<span class="spinner"></span> Verarbeitung...';
            
            const startTime = performance.now();

            try {
                // FormData f√ºr Backend-Request
                const formData = new FormData();
                formData.append('audio', state.audioBlob, 'recording.webm');
                formData.append('language', state.currentLanguage);

                // TODO: Backend-Endpoint anpassen
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const endTime = performance.now();
                state.processingTime = ((endTime - startTime) / 1000).toFixed(2);

                // Ergebnisse anzeigen
                elements.output.value = data.text || 'Keine Transkription verf√ºgbar';
                state.detectedLanguage = data.language || state.currentLanguage;
                state.confidence = data.confidence ? `${(data.confidence * 100).toFixed(1)}%` : '‚Äî';
                
                updateMetadata();
                updateStatus('ready', 'Status: Transkribiert');
                showFeedback('Transkription erfolgreich!', 'success');

            } catch (error) {
                console.error('Transkriptions-Fehler:', error);
                
                // Fallback: Demo-Text f√ºr Entwicklung
                if (error.message.includes('Failed to fetch') || error.message.includes('404')) {
                    elements.output.value = '[DEMO-MODUS] Backend nicht verf√ºgbar.\n\nBitte konfigurieren Sie das Backend unter /api/transcribe\n\nErwartetes Response-Format:\n{\n  "text": "Transkribierter Text",\n  "language": "de",\n  "confidence": 0.95\n}';
                    state.processingTime = '0.00';
                    updateMetadata();
                    updateStatus('ready', 'Status: Demo-Modus');
                    showFeedback('Demo-Modus: Backend nicht verf√ºgbar', 'error');
                } else {
                    showFeedback(`Fehler: ${error.message}`, 'error');
                    updateStatus('error', 'Status: Fehler');
                }
            } finally {
                elements.btnTranscribe.disabled = false;
                elements.btnTranscribe.innerHTML = '‚ú® Transcribe';
            }
        }

        // ===== UI UPDATES =====
        function updateStatus(type, message) {
            elements.status.className = `status-badge ${type}`;
            elements.status.innerHTML = type === 'recording' 
                ? `<span class="recording-indicator"></span>${message}`
                : message;
        }

        function updateButtons() {
            elements.btnStart.disabled = state.isRecording;
            elements.btnStop.disabled = !state.isRecording;
        }

        function updateMetadata() {
            elements.detectedLang.textContent = state.detectedLanguage 
                ? getLanguageName(state.detectedLanguage) 
                : '‚Äî';
            elements.duration.textContent = state.audioDuration 
                ? `${state.audioDuration} Sekunden` 
                : '‚Äî';
            elements.confidence.textContent = state.confidence || '‚Äî';
            elements.processingTime.textContent = state.processingTime 
                ? `${state.processingTime}s` 
                : '‚Äî';
        }

        function updateDuration() {
            elements.duration.textContent = state.audioDuration 
                ? `${state.audioDuration} Sekunden` 
                : '‚Äî';
        }

        function getLanguageName(code) {
            const names = {
                'de': 'Deutsch üá©üá™',
                'en': 'English üá¨üáß',
                'fr': 'Fran√ßais üá´üá∑'
            };
            return names[code] || code;
        }

        // ===== COPY TO CLIPBOARD =====
        async function copyToClipboard() {
            const text = elements.output.value;
            if (!text) {
                showFeedback('Kein Text zum Kopieren', 'error');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                const originalText = elements.btnCopy.innerHTML;
                elements.btnCopy.innerHTML = '‚úì Kopiert!';
                elements.btnCopy.style.background = 'var(--success)';
                showFeedback('Text in Zwischenablage kopiert', 'success');
                
                setTimeout(() => {
                    elements.btnCopy.innerHTML = originalText;
                    elements.btnCopy.style.background = '';
                }, 2000);
            } catch (error) {
                console.error('Fehler beim Kopieren:', error);
                showFeedback('Fehler beim Kopieren', 'error');
            }
        }

        // ===== CLEAR OUTPUT =====
        function clearOutput() {
            elements.output.value = '';
            state.audioBlob = null;
            state.detectedLanguage = null;
            state.confidence = null;
            state.processingTime = null;
            state.audioDuration = null;
            state.timer = 0;
            updateTimer();
            updateMetadata();
            elements.btnTranscribe.disabled = true;
            updateStatus('ready', 'Status: Bereit');
            showFeedback('Ausgabe gel√∂scht', 'success');
        }

        // ===== FEEDBACK MESSAGES =====
        function showFeedback(message, type = 'success') {
            const feedback = document.createElement('div');
            feedback.className = `feedback ${type}`;
            feedback.textContent = message;
            document.body.appendChild(feedback);

            setTimeout(() => {
                feedback.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => feedback.remove(), 300);
            }, type === 'error' ? 5000 : 3000);
        }

        // ===== KEYBOARD SHORTCUTS =====
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // SPACE = Start/Stop Toggle
                if (e.code === 'Space' && !e.target.matches('textarea, input')) {
                    e.preventDefault();
                    if (state.isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                }

                // CTRL+ENTER = Transcribe
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    if (!elements.btnTranscribe.disabled) {
                        transcribe();
                    }
                }

                // CTRL+C = Copy (nur wenn Output fokussiert)
                if (e.ctrlKey && e.key === 'c' && document.activeElement === elements.output) {
                    e.preventDefault();
                    copyToClipboard();
                }

                // CTRL+DEL = Clear
                if (e.ctrlKey && e.key === 'Delete') {
                    e.preventDefault();
                    clearOutput();
                }
            });
        }

        // ===== EVENT LISTENERS =====
        function initEventListeners() {
            elements.btnStart.addEventListener('click', startRecording);
            elements.btnStop.addEventListener('click', stopRecording);
            elements.btnTranscribe.addEventListener('click', transcribe);
            elements.btnCopy.addEventListener('click', copyToClipboard);
            elements.btnClear.addEventListener('click', clearOutput);
        }

        // ===== INITIALIZATION =====
        function init() {
            initTheme();
            initLanguage();
            initEventListeners();
            initKeyboardShortcuts();
            updateMetadata();
            updateTimer();
        }

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>

